"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getVertices = getVertices;
exports.getCentroid = getCentroid;
exports.idToPolygonGeo = idToPolygonGeo;
exports.getCenterHex = getCenterHex;
exports.getH3VerticeTransform = getH3VerticeTransform;
exports.distortCylinderPositions = distortCylinderPositions;
exports.getRadius = getRadius;
exports.getAngle = getAngle;
Object.defineProperty(exports, "h3GetResolution", {
  enumerable: true,
  get: function get() {
    return _h3Js.h3GetResolution;
  }
});
Object.defineProperty(exports, "h3IsValid", {
  enumerable: true,
  get: function get() {
    return _h3Js.h3IsValid;
  }
});
exports.getHexFields = exports.isHexField = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _h3Js = require("h3-js");

var _defaultSettings = require("../../constants/default-settings");

var _dataUtils = require("../../utils/data-utils");

// Copyright (c) 2020 Uber Technologies, Inc.
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.
// get vertices should return [lon, lat]
function getVertices(_ref) {
  var id = _ref.id;
  // always reverse it
  return (0, _h3Js.h3ToGeoBoundary)(id, true);
} // get centroid should return [lon, lat]


function getCentroid(_ref2) {
  var id = _ref2.id;
  // always reverse it to [lng, lat]
  return (0, _h3Js.h3ToGeo)(id).reverse();
}

function idToPolygonGeo(_ref3, properties) {
  var object = _ref3.object;

  if (!object || !object.id) {
    return null;
  }

  var vertices = getVertices(object);
  return {
    geometry: {
      coordinates: vertices,
      type: 'LineString'
    },
    properties: properties
  };
}

function getCenterHex(_ref4, resolution) {
  var latitude = _ref4.latitude,
      longitude = _ref4.longitude;
  return (0, _h3Js.geoToH3)(latitude, longitude, resolution);
} // H3 hexagon are not perfect hexagon after projection, they are slightly distorted
// Here we calculate the distortion from perfect hexagon to h3 hexagon
// A mathematica proof can be found at
// https://beta.observablehq.com/@heshan0131/h3-hexagon-shape-normalize


function getH3VerticeTransform(rawVertices, centroid) {
  var vertices = revertVertices(rawVertices.map(function (vt) {
    return offset(vt, centroid);
  }));
  var radius = getRadius(vertices[0], vertices[3]);
  var angle = getAngle(vertices[0], vertices[3]); // rotate hexagon vertices, so that v0 - v3 axis parallel with xAxis
  //   2___1
  // 3 /   \ 0
  //   \___/
  //   4   5
  //

  var rotatedVertices = vertices.map(function (vt) {
    return rotate([0, 0], vt, angle);
  }); // vertices of a perfect hexagon

  var normalVertices = getHexagonVertices(radius); // calculate distortion

  return getDistortions(rotatedVertices, normalVertices);
} // Vertices index based on
// https://github.com/uber/luma.gl/blob/master/modules/core/src/geometry/truncated-cone-geometry.js


function distortCylinderPositions(positions, distortions) {
  var primitives = distortions.map(function (_ref5, i) {
    var dr = _ref5.dr,
        da = _ref5.da;
    return getPtOnCircle(dr, da + Math.PI * i / 3);
  }); // close it

  primitives.push(primitives[0]); // starting from the 8th vertice, repeat 4 times, only replace x(0), y(1)

  return positions.map(function (v, i) {
    if (i > 20 && i < 21 * 5 && i % 3 < 2) {
      var row = Math.floor(i / 3);
      var col = i % 3;
      return primitives[row % 7][col];
    }

    return v;
  });
}

function offset(_ref6, _ref7) {
  var _ref8 = (0, _slicedToArray2["default"])(_ref6, 2),
      px = _ref8[0],
      py = _ref8[1];

  var _ref9 = (0, _slicedToArray2["default"])(_ref7, 2),
      x0 = _ref9[0],
      y0 = _ref9[1];

  return [[px - x0], [py - y0]];
}

function rotate(_ref10, _ref11, radians) {
  var _ref12 = (0, _slicedToArray2["default"])(_ref10, 2),
      cx = _ref12[0],
      cy = _ref12[1];

  var _ref13 = (0, _slicedToArray2["default"])(_ref11, 2),
      x = _ref13[0],
      y = _ref13[1];

  var cos = Math.cos(radians);
  var sin = Math.sin(radians);
  var nx = cos * (x - cx) + sin * (y - cy) + cx;
  var ny = cos * (y - cy) - sin * (x - cx) + cy;
  return [nx, ny];
}

function getDistance(pt0, pt1) {
  var dx = pt0[0] - pt1[0];
  var dy = pt0[1] - pt1[1];
  var dxy = Math.sqrt(dx * dx + dy * dy);
  return dxy;
}

function getRadius(pt0, pt3) {
  var dxy = getDistance(pt0, pt3);
  return dxy / 2;
}

function getAngle(pt0, pt3) {
  var dx = pt0[0] - pt3[0];
  var dy = pt0[1] - pt3[1];
  var dxy = Math.sqrt(dx * dx + dy * dy); // Calculate angle that the perpendicular hexagon vertex axis is tilted

  var angle = Math.acos(dx / dxy) * Math.sign(dy);
  return angle;
}

function getPtOnCircle(radius, angle) {
  return [radius * Math.cos(angle), radius * Math.sin(angle)];
}

function getHexagonVertices(r) {
  var ang60 = Math.PI / 3;
  var pts = [];

  for (var i = 0; i < 6; i++) {
    pts.push(getPtOnCircle(r, ang60 * i));
  }

  return pts;
}

function revertVertices(verts) {
  // reverting verts from clock (h3) to counter clock wise (luma cylinder)
  var seq = [0, 5, 4, 3, 2, 1];
  return seq.map(function (s) {
    return verts[s];
  });
}

function getDistortions(vts, origs) {
  // 0 and 3 should be the guide
  var ct = [0, 0];
  var distortions = [];

  for (var i = 0; i < 6; i++) {
    var vt = vts[i];
    var org = origs[i];
    var r = getRadius(org, ct);
    var dr = getRadius(vt, ct) / r;
    var da = Math.atan2(vt[1], vt[0]) - Math.atan2(org[1], org[0]);
    distortions.push({
      dr: dr,
      da: da
    });
  }

  return distortions;
}

var isHexField = function isHexField(field, fieldIdx, allData) {
  if (!field.type === _defaultSettings.ALL_FIELD_TYPES.string) {
    return false;
  }

  var firstDP = allData.find(function (d) {
    return (0, _dataUtils.notNullorUndefined)(d[fieldIdx]);
  });
  return firstDP && (0, _h3Js.h3IsValid)(firstDP[fieldIdx]);
};

exports.isHexField = isHexField;

var getHexFields = function getHexFields(fields, allData) {
  return fields.filter(function (f, i) {
    return isHexField(f, i, allData);
  });
};

exports.getHexFields = getHexFields;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvaDMtaGV4YWdvbi1sYXllci9oMy11dGlscy5qcyJdLCJuYW1lcyI6WyJnZXRWZXJ0aWNlcyIsImlkIiwiZ2V0Q2VudHJvaWQiLCJyZXZlcnNlIiwiaWRUb1BvbHlnb25HZW8iLCJwcm9wZXJ0aWVzIiwib2JqZWN0IiwidmVydGljZXMiLCJnZW9tZXRyeSIsImNvb3JkaW5hdGVzIiwidHlwZSIsImdldENlbnRlckhleCIsInJlc29sdXRpb24iLCJsYXRpdHVkZSIsImxvbmdpdHVkZSIsImdldEgzVmVydGljZVRyYW5zZm9ybSIsInJhd1ZlcnRpY2VzIiwiY2VudHJvaWQiLCJyZXZlcnRWZXJ0aWNlcyIsIm1hcCIsInZ0Iiwib2Zmc2V0IiwicmFkaXVzIiwiZ2V0UmFkaXVzIiwiYW5nbGUiLCJnZXRBbmdsZSIsInJvdGF0ZWRWZXJ0aWNlcyIsInJvdGF0ZSIsIm5vcm1hbFZlcnRpY2VzIiwiZ2V0SGV4YWdvblZlcnRpY2VzIiwiZ2V0RGlzdG9ydGlvbnMiLCJkaXN0b3J0Q3lsaW5kZXJQb3NpdGlvbnMiLCJwb3NpdGlvbnMiLCJkaXN0b3J0aW9ucyIsInByaW1pdGl2ZXMiLCJpIiwiZHIiLCJkYSIsImdldFB0T25DaXJjbGUiLCJNYXRoIiwiUEkiLCJwdXNoIiwidiIsInJvdyIsImZsb29yIiwiY29sIiwicHgiLCJweSIsIngwIiwieTAiLCJyYWRpYW5zIiwiY3giLCJjeSIsIngiLCJ5IiwiY29zIiwic2luIiwibngiLCJueSIsImdldERpc3RhbmNlIiwicHQwIiwicHQxIiwiZHgiLCJkeSIsImR4eSIsInNxcnQiLCJwdDMiLCJhY29zIiwic2lnbiIsInIiLCJhbmc2MCIsInB0cyIsInZlcnRzIiwic2VxIiwicyIsInZ0cyIsIm9yaWdzIiwiY3QiLCJvcmciLCJhdGFuMiIsImlzSGV4RmllbGQiLCJmaWVsZCIsImZpZWxkSWR4IiwiYWxsRGF0YSIsIkFMTF9GSUVMRF9UWVBFUyIsInN0cmluZyIsImZpcnN0RFAiLCJmaW5k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QUFnQkMsTUFBcEMsRUFBNEM7QUFDMUMsV0FBTyxLQUFQO0FBQ0Q7O0FBQ0QsTUFBTUMsT0FBTyxHQUFHSCxPQUFPLENBQUNJLElBQVIsQ0FBYSxVQUFBQyxDQUFDO0FBQUEsV0FBSSxtQ0FBbUJBLENBQUMsQ0FBQ04sUUFBRCxDQUFwQixDQUFKO0FBQUEsR0FBZCxDQUFoQjtBQUNBLFNBQU9JLE9BQU8sSUFBSSxxQkFBVUEsT0FBTyxDQUFDSixRQUFELENBQWpCLENBQWxCO0FBQ0QsQ0FOTTs7OztBQVFBLElBQU1PLFlBQVksR0FBRyxTQUFmQSxZQUFlLENBQUNDLE1BQUQsRUFBU1AsT0FBVDtBQUFBLFNBQXFCTyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxVQUFDQyxDQUFELEVBQUl6RCxDQUFKO0FBQUEsV0FBVTZDLFVBQVUsQ0FBQ1ksQ0FBRCxFQUFJekQsQ0FBSixFQUFPZ0QsT0FBUCxDQUFwQjtBQUFBLEdBQWQsQ0FBckI7QUFBQSxDQUFyQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgMjAyMCBVYmVyIFRlY2hub2xvZ2llcywgSW5jLlxuLy9cbi8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbi8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbi8vIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbi8vIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbi8vXG4vLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpblxuLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4vL1xuLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuLy8gSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4vLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbi8vIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbi8vIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4vLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOXG4vLyBUSEUgU09GVFdBUkUuXG5cbmltcG9ydCB7aDNHZXRSZXNvbHV0aW9uLCBoM0lzVmFsaWQsIGgzVG9HZW8sIGgzVG9HZW9Cb3VuZGFyeSwgZ2VvVG9IM30gZnJvbSAnaDMtanMnO1xuaW1wb3J0IHtBTExfRklFTERfVFlQRVN9IGZyb20gJ2NvbnN0YW50cy9kZWZhdWx0LXNldHRpbmdzJztcbmltcG9ydCB7bm90TnVsbG9yVW5kZWZpbmVkfSBmcm9tICd1dGlscy9kYXRhLXV0aWxzJztcblxuZXhwb3J0IHtoM0dldFJlc29sdXRpb24sIGgzSXNWYWxpZH07XG5cbi8vIGdldCB2ZXJ0aWNlcyBzaG91bGQgcmV0dXJuIFtsb24sIGxhdF1cbmV4cG9ydCBmdW5jdGlvbiBnZXRWZXJ0aWNlcyh7aWR9KSB7XG4gIC8vIGFsd2F5cyByZXZlcnNlIGl0XG4gIHJldHVybiBoM1RvR2VvQm91bmRhcnkoaWQsIHRydWUpO1xufVxuXG4vLyBnZXQgY2VudHJvaWQgc2hvdWxkIHJldHVybiBbbG9uLCBsYXRdXG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2VudHJvaWQoe2lkfSkge1xuICAvLyBhbHdheXMgcmV2ZXJzZSBpdCB0byBbbG5nLCBsYXRdXG4gIHJldHVybiBoM1RvR2VvKGlkKS5yZXZlcnNlKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpZFRvUG9seWdvbkdlbyh7b2JqZWN0fSwgcHJvcGVydGllcykge1xuICBpZiAoIW9iamVjdCB8fCAhb2JqZWN0LmlkKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCB2ZXJ0aWNlcyA9IGdldFZlcnRpY2VzKG9iamVjdCk7XG5cbiAgcmV0dXJuIHtcbiAgICBnZW9tZXRyeToge1xuICAgICAgY29vcmRpbmF0ZXM6IHZlcnRpY2VzLFxuICAgICAgdHlwZTogJ0xpbmVTdHJpbmcnXG4gICAgfSxcbiAgICBwcm9wZXJ0aWVzXG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDZW50ZXJIZXgoe2xhdGl0dWRlLCBsb25naXR1ZGV9LCByZXNvbHV0aW9uKSB7XG4gIHJldHVybiBnZW9Ub0gzKGxhdGl0dWRlLCBsb25naXR1ZGUsIHJlc29sdXRpb24pO1xufVxuXG4vLyBIMyBoZXhhZ29uIGFyZSBub3QgcGVyZmVjdCBoZXhhZ29uIGFmdGVyIHByb2plY3Rpb24sIHRoZXkgYXJlIHNsaWdodGx5IGRpc3RvcnRlZFxuLy8gSGVyZSB3ZSBjYWxjdWxhdGUgdGhlIGRpc3RvcnRpb24gZnJvbSBwZXJmZWN0IGhleGFnb24gdG8gaDMgaGV4YWdvblxuLy8gQSBtYXRoZW1hdGljYSBwcm9vZiBjYW4gYmUgZm91bmQgYXRcbi8vIGh0dHBzOi8vYmV0YS5vYnNlcnZhYmxlaHEuY29tL0BoZXNoYW4wMTMxL2gzLWhleGFnb24tc2hhcGUtbm9ybWFsaXplXG5leHBvcnQgZnVuY3Rpb24gZ2V0SDNWZXJ0aWNlVHJhbnNmb3JtKHJhd1ZlcnRpY2VzLCBjZW50cm9pZCkge1xuICBjb25zdCB2ZXJ0aWNlcyA9IHJldmVydFZlcnRpY2VzKHJhd1ZlcnRpY2VzLm1hcCh2dCA9PiBvZmZzZXQodnQsIGNlbnRyb2lkKSkpO1xuICBjb25zdCByYWRpdXMgPSBnZXRSYWRpdXModmVydGljZXNbMF0sIHZlcnRpY2VzWzNdKTtcblxuICBjb25zdCBhbmdsZSA9IGdldEFuZ2xlKHZlcnRpY2VzWzBdLCB2ZXJ0aWNlc1szXSk7XG5cbiAgLy8gcm90YXRlIGhleGFnb24gdmVydGljZXMsIHNvIHRoYXQgdjAgLSB2MyBheGlzIHBhcmFsbGVsIHdpdGggeEF4aXNcbiAgLy8gICAyX19fMVxuICAvLyAzIC8gICBcXCAwXG4gIC8vICAgXFxfX18vXG4gIC8vICAgNCAgIDVcbiAgLy9cbiAgY29uc3Qgcm90YXRlZFZlcnRpY2VzID0gdmVydGljZXMubWFwKHZ0ID0+IHJvdGF0ZShbMCwgMF0sIHZ0LCBhbmdsZSkpO1xuXG4gIC8vIHZlcnRpY2VzIG9mIGEgcGVyZmVjdCBoZXhhZ29uXG4gIGNvbnN0IG5vcm1hbFZlcnRpY2VzID0gZ2V0SGV4YWdvblZlcnRpY2VzKHJhZGl1cyk7XG5cbiAgLy8gY2FsY3VsYXRlIGRpc3RvcnRpb25cbiAgcmV0dXJuIGdldERpc3RvcnRpb25zKHJvdGF0ZWRWZXJ0aWNlcywgbm9ybWFsVmVydGljZXMpO1xufVxuXG4vLyBWZXJ0aWNlcyBpbmRleCBiYXNlZCBvblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL3ViZXIvbHVtYS5nbC9ibG9iL21hc3Rlci9tb2R1bGVzL2NvcmUvc3JjL2dlb21ldHJ5L3RydW5jYXRlZC1jb25lLWdlb21ldHJ5LmpzXG5leHBvcnQgZnVuY3Rpb24gZGlzdG9ydEN5bGluZGVyUG9zaXRpb25zKHBvc2l0aW9ucywgZGlzdG9ydGlvbnMpIHtcbiAgY29uc3QgcHJpbWl0aXZlcyA9IGRpc3RvcnRpb25zLm1hcCgoe2RyLCBkYX0sIGkpID0+IGdldFB0T25DaXJjbGUoZHIsIGRhICsgKE1hdGguUEkgKiBpKSAvIDMpKTtcbiAgLy8gY2xvc2UgaXRcbiAgcHJpbWl0aXZlcy5wdXNoKHByaW1pdGl2ZXNbMF0pO1xuXG4gIC8vIHN0YXJ0aW5nIGZyb20gdGhlIDh0aCB2ZXJ0aWNlLCByZXBlYXQgNCB0aW1lcywgb25seSByZXBsYWNlIHgoMCksIHkoMSlcbiAgcmV0dXJuIHBvc2l0aW9ucy5tYXAoKHYsIGkpID0+IHtcbiAgICBpZiAoaSA+IDIwICYmIGkgPCAyMSAqIDUgJiYgaSAlIDMgPCAyKSB7XG4gICAgICBjb25zdCByb3cgPSBNYXRoLmZsb29yKGkgLyAzKTtcbiAgICAgIGNvbnN0IGNvbCA9IGkgJSAzO1xuICAgICAgcmV0dXJuIHByaW1pdGl2ZXNbcm93ICUgN11bY29sXTtcbiAgICB9XG4gICAgcmV0dXJuIHY7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBvZmZzZXQoW3B4LCBweV0sIFt4MCwgeTBdKSB7XG4gIHJldHVybiBbW3B4IC0geDBdLCBbcHkgLSB5MF1dO1xufVxuXG5mdW5jdGlvbiByb3RhdGUoW2N4LCBjeV0sIFt4LCB5XSwgcmFkaWFucykge1xuICBjb25zdCBjb3MgPSBNYXRoLmNvcyhyYWRpYW5zKTtcbiAgY29uc3Qgc2luID0gTWF0aC5zaW4ocmFkaWFucyk7XG4gIGNvbnN0IG54ID0gY29zICogKHggLSBjeCkgKyBzaW4gKiAoeSAtIGN5KSArIGN4O1xuICBjb25zdCBueSA9IGNvcyAqICh5IC0gY3kpIC0gc2luICogKHggLSBjeCkgKyBjeTtcblxuICByZXR1cm4gW254LCBueV07XG59XG5cbmZ1bmN0aW9uIGdldERpc3RhbmNlKHB0MCwgcHQxKSB7XG4gIGNvbnN0IGR4ID0gcHQwWzBdIC0gcHQxWzBdO1xuICBjb25zdCBkeSA9IHB0MFsxXSAtIHB0MVsxXTtcbiAgY29uc3QgZHh5ID0gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTtcbiAgcmV0dXJuIGR4eTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFJhZGl1cyhwdDAsIHB0Mykge1xuICBjb25zdCBkeHkgPSBnZXREaXN0YW5jZShwdDAsIHB0Myk7XG4gIHJldHVybiBkeHkgLyAyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0QW5nbGUocHQwLCBwdDMpIHtcbiAgY29uc3QgZHggPSBwdDBbMF0gLSBwdDNbMF07XG4gIGNvbnN0IGR5ID0gcHQwWzFdIC0gcHQzWzFdO1xuICBjb25zdCBkeHkgPSBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpO1xuXG4gIC8vIENhbGN1bGF0ZSBhbmdsZSB0aGF0IHRoZSBwZXJwZW5kaWN1bGFyIGhleGFnb24gdmVydGV4IGF4aXMgaXMgdGlsdGVkXG4gIGNvbnN0IGFuZ2xlID0gTWF0aC5hY29zKGR4IC8gZHh5KSAqIE1hdGguc2lnbihkeSk7XG4gIHJldHVybiBhbmdsZTtcbn1cblxuZnVuY3Rpb24gZ2V0UHRPbkNpcmNsZShyYWRpdXMsIGFuZ2xlKSB7XG4gIHJldHVybiBbcmFkaXVzICogTWF0aC5jb3MoYW5nbGUpLCByYWRpdXMgKiBNYXRoLnNpbihhbmdsZSldO1xufVxuXG5mdW5jdGlvbiBnZXRIZXhhZ29uVmVydGljZXMocikge1xuICBjb25zdCBhbmc2MCA9IE1hdGguUEkgLyAzO1xuICBjb25zdCBwdHMgPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHtcbiAgICBwdHMucHVzaChnZXRQdE9uQ2lyY2xlKHIsIGFuZzYwICogaSkpO1xuICB9XG5cbiAgcmV0dXJuIHB0cztcbn1cblxuZnVuY3Rpb24gcmV2ZXJ0VmVydGljZXModmVydHMpIHtcbiAgLy8gcmV2ZXJ0aW5nIHZlcnRzIGZyb20gY2xvY2sgKGgzKSB0byBjb3VudGVyIGNsb2NrIHdpc2UgKGx1bWEgY3lsaW5kZXIpXG4gIGNvbnN0IHNlcSA9IFswLCA1LCA0LCAzLCAyLCAxXTtcbiAgcmV0dXJuIHNlcS5tYXAocyA9PiB2ZXJ0c1tzXSk7XG59XG5cbmZ1bmN0aW9uIGdldERpc3RvcnRpb25zKHZ0cywgb3JpZ3MpIHtcbiAgLy8gMCBhbmQgMyBzaG91bGQgYmUgdGhlIGd1aWRlXG4gIGNvbnN0IGN0ID0gWzAsIDBdO1xuICBjb25zdCBkaXN0b3J0aW9ucyA9IFtdO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgNjsgaSsrKSB7XG4gICAgY29uc3QgdnQgPSB2dHNbaV07XG4gICAgY29uc3Qgb3JnID0gb3JpZ3NbaV07XG5cbiAgICBjb25zdCByID0gZ2V0UmFkaXVzKG9yZywgY3QpO1xuICAgIGNvbnN0IGRyID0gZ2V0UmFkaXVzKHZ0LCBjdCkgLyByO1xuXG4gICAgY29uc3QgZGEgPSBNYXRoLmF0YW4yKHZ0WzFdLCB2dFswXSkgLSBNYXRoLmF0YW4yKG9yZ1sxXSwgb3JnWzBdKTtcblxuICAgIGRpc3RvcnRpb25zLnB1c2goe2RyLCBkYX0pO1xuICB9XG5cbiAgcmV0dXJuIGRpc3RvcnRpb25zO1xufVxuXG5leHBvcnQgY29uc3QgaXNIZXhGaWVsZCA9IChmaWVsZCwgZmllbGRJZHgsIGFsbERhdGEpID0+IHtcbiAgaWYgKCFmaWVsZC50eXBlID09PSBBTExfRklFTERfVFlQRVMuc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGNvbnN0IGZpcnN0RFAgPSBhbGxEYXRhLmZpbmQoZCA9PiBub3ROdWxsb3JVbmRlZmluZWQoZFtmaWVsZElkeF0pKTtcbiAgcmV0dXJuIGZpcnN0RFAgJiYgaDNJc1ZhbGlkKGZpcnN0RFBbZmllbGRJZHhdKTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRIZXhGaWVsZHMgPSAoZmllbGRzLCBhbGxEYXRhKSA9PiBmaWVsZHMuZmlsdGVyKChmLCBpKSA9PiBpc0hleEZpZWxkKGYsIGksIGFsbERhdGEpKTtcbiJdfQ==